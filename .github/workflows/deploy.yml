# =============================================================================
# ðŸš€ KALLPA UNL - Frontend CI/CD Pipeline
# =============================================================================
# Pipeline para despliegue automÃ¡tico del frontend Next.js en Azure Static Web App
# Framework: Next.js 15.1.6 | React 19.0.0 | Node 20.x LTS
# =============================================================================

name: ðŸŽ¨ Frontend - Build & Deploy

on:
  push:
    branches:
      - main
      - production
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main
      - production

# Evita ejecuciones duplicadas
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20.x'
  NEXT_TELEMETRY_DISABLED: 1

jobs:
  # ===========================================================================
  # ðŸ”¨ BUILD JOB
  # ===========================================================================
  build:
    name: ðŸ”¨ Build Frontend
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    
    steps:
      # -----------------------------------------------------------------------
      # ðŸ“¥ Checkout cÃ³digo
      # -----------------------------------------------------------------------
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------------------------------------------------
      # ðŸŸ¢ Setup Node.js con cache
      # -----------------------------------------------------------------------
      - name: ðŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      # -----------------------------------------------------------------------
      # ðŸ“¦ Cache de node_modules
      # -----------------------------------------------------------------------
      - name: ðŸ“¦ Cache node_modules
        uses: actions/cache@v4
        id: cache-node-modules
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ env.NODE_VERSION }}-
            ${{ runner.os }}-node-

      # -----------------------------------------------------------------------
      # ðŸ“¦ Cache de Next.js
      # -----------------------------------------------------------------------
      - name: ðŸ“¦ Cache Next.js build
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}-
            ${{ runner.os }}-nextjs-

      # -----------------------------------------------------------------------
      # ðŸ“¥ Instalar dependencias
      # -----------------------------------------------------------------------
      - name: ðŸ“¥ Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit

      # -----------------------------------------------------------------------
      # ðŸ” Lint (opcional pero recomendado)
      # -----------------------------------------------------------------------
      - name: ðŸ” Run ESLint
        run: npm run lint --if-present
        continue-on-error: true

      # -----------------------------------------------------------------------
      # ðŸ—ï¸ Build de producciÃ³n
      # -----------------------------------------------------------------------
      - name: ðŸ—ï¸ Build Next.js application
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL || 'https://api.kallpa-unl.azurewebsites.net' }}

      # -----------------------------------------------------------------------
      # ðŸ“¤ Upload artifact para deploy
      # -----------------------------------------------------------------------
      - name: ðŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: |
            .next
            public
            package.json
            package-lock.json
            next.config.mjs
          retention-days: 1
          if-no-files-found: error

  # ===========================================================================
  # ðŸš€ DEPLOY JOB - Azure Static Web App
  # ===========================================================================
  deploy-static-web-app:
    name: ðŸš€ Deploy to Azure Static Web App
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production')
    
    environment:
      name: ${{ github.ref == 'refs/heads/production' && 'production' || 'staging' }}
      url: ${{ steps.deploy.outputs.static_web_app_url }}

    steps:
      # -----------------------------------------------------------------------
      # ðŸ“¥ Checkout cÃ³digo
      # -----------------------------------------------------------------------
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      # -----------------------------------------------------------------------
      # ðŸ“¥ Download build artifact
      # -----------------------------------------------------------------------
      - name: ðŸ“¥ Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: nextjs-build

      # -----------------------------------------------------------------------
      # ðŸš€ Deploy a Azure Static Web App
      # -----------------------------------------------------------------------
      - name: ðŸš€ Deploy to Azure Static Web App
        id: deploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          # ConfiguraciÃ³n de rutas
          app_location: "/"
          api_location: ""
          output_location: ".next"
          # ConfiguraciÃ³n adicional
          skip_app_build: true
          skip_api_build: true

  # ===========================================================================
  # ðŸ—‘ï¸ CLEANUP JOB - Para PRs cerrados
  # ===========================================================================
  close-pull-request:
    name: ðŸ—‘ï¸ Close PR Preview
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    
    steps:
      - name: ðŸ—‘ï¸ Close Pull Request
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          action: "close"

  # ===========================================================================
  # ðŸ“¢ NOTIFICATION JOB (opcional)
  # ===========================================================================
  notify:
    name: ðŸ“¢ Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [build, deploy-static-web-app]
    if: always() && github.event_name == 'push'
    
    steps:
      - name: ðŸ“¢ Deployment Summary
        run: |
          echo "## ðŸŽ¨ Frontend Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”¨ Build | ${{ needs.build.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ Deploy | ${{ needs.deploy-static-web-app.result == 'success' && 'âœ… Success' || needs.deploy-static-web-app.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
